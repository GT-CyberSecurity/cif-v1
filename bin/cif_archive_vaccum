#!/usr/bin/perl

use warnings;
use strict;

# fix lib paths, some may be relative
BEGIN {
    require File::Spec;
    my @libs = ("lib", "local/lib");
    my $bin_path;

    for my $lib (@libs) {
        unless ( File::Spec->file_name_is_absolute($lib) ) {
            unless ($bin_path) {
                if ( File::Spec->file_name_is_absolute(__FILE__) ) {
                    $bin_path = ( File::Spec->splitpath(__FILE__) )[1];
                }
                else {
                    require FindBin;
                    no warnings "once";
                    $bin_path = $FindBin::Bin;
                }
            }
            $lib = File::Spec->catfile( $bin_path, File::Spec->updir, $lib );
        }
        unshift @INC, $lib;
    }

}

use lib './lib';
use lib '../cif-perl/lib';

use Getopt::Std;
use DateTime;
use Config::Simple;
use Data::Dumper;
use CIF::Archive;

my %opts;
getopts('dC:S:R:c:D:l:h',\%opts);

our $debug          = $opts{'d'};
my $config          = $opts{'C'} || $ENV{'HOME'}.'/.cif';
my $limit_days      = $opts{'D'} || 365;
my $mutex           = $opts{'L'} || '/tmp/cif_archive_vaccum.lock';

die usage() if($opts{'h'});

sub usage {
    return <<EOF;
Usage: perl $0 -c 95

    -h  --help:         this meessage

Basic Usage:
    -C  --config:       specify an alternate config location, default $config
    -d  --debug
    -D  --limit_days:   max days to go back in feed search, default: $limit_days

Examples:

    $0 -D 180

EOF
}

$SIG{'INT'} = 'cleanup';
$SIG{__DIE__} = 'cleanup';

my $start = time();

## TODO: move these to libcif
sub _debug {
    return unless($debug);
    my $msg = shift;
    my ($pkg,$f,$line) = caller();
    warn "[DEBUG] $line: $msg";
}

sub _profile {
    my ($msg) = @_;
    _debug('('.(time() - $start).') '.$msg);
}

sub cleanup {
    my $msg = shift;
    if($msg){   
        print $msg."\n";
    } else {
        print "\n\nCaught Interrupt (^C), Aborting\n";
    }
    remove_lock();
    exit(1);
}

sub remove_lock {
    system('rm '.$mutex);
}

if(-e $mutex){
    print 'already running, mutex found: '.$mutex."\n" if($debug);
    exit(-1);
}
my $ret = system('touch '.$mutex);
unless(defined($ret) && $ret == 0){
    die($!);
}

my $err;
my $timestamp = DateTime->from_epoch(epoch => (time() - ((1 + $limit_days) * 84600)));
$timestamp = $timestamp->ymd().'T00:00:00Z';

my $archive = CIF::Archive->new({ config => $config });
($err,$ret) = $archive->vaccum({ timestamp => $timestamp });

die $err if($err);

warn 'records removed: '.$ret if($ret && $ret > 0 && $debug);

warn 'done...' if($debug);

remove_lock();
exit(0);


